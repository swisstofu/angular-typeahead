angular.module("siyfion.sfTypeahead",[]).directive("sfTypeahead",function(){return{restrict:"AC",require:"?ngModel",scope:{options:"=",datasets:"=",suggestionKey:"@",modelKey:"@"},link:function(a,b,c,d){function e(){if(j)k.typeahead(a.options,a.datasets),k.on("focus",function(){k.typeahead("val",d.$viewValue)}),j=!1;else{k.val();k.typeahead("destroy"),k.typeahead(a.options,a.datasets),k.triggerHandler("typeahead:opened")}}function f(b,c){var d=-1;return angular.forEach(b,function(b,e){angular.isDefined(a.modelKey)&&angular.equals(c[a.modelKey],b[a.modelKey])?d=e:angular.equals(c,b)&&(d=e)}),d>=0}function g(b,c,e){a.$apply(function(){if(a.modelKey)d.$setViewValue(c[a.modelKey]);else{var b=angular.isDefined(a.suggestionKey)?c[a.suggestionKey]:c;d.$setViewValue(b)}})}var h=a.options||{},i=(angular.isArray(a.datasets)?a.datasets:[a.datasets])||[],j=!0,k=$(b);e(),a.$watch("options",e),angular.isArray(a.datasets)?a.$watchCollection("datasets",e):a.$watch("datasets",e),d.$parsers.push(function(a){if(angular.isObject(d.$modelValue)&&a===k.typeahead("val"))return d.$modelValue;var b=angular.isObject(a);return h.editable===!1?(d.$setValidity("typeahead",b),b?a:void 0):a}),d.$formatters.push(function(b){if(angular.isObject(b)){var c=!1;return $.each(i,function(e,g){function j(g){var j=f(g,b);j?(d.$setViewValue(a.modelKey?b[a.modelKey]:b),c=!0):d.$setViewValue(h.editable===!1?void 0:b),(c||e===i.length-1)&&setTimeout(function(){a.$apply(function(){k.typeahead("val",n)})},0)}var l=g.source,m=g.displayKey||"value",n=(angular.isFunction(m)?m(b):b[m])||"";return c?!1:n?void l(n,void 0,j):void j([])}),""}return null==b?k.typeahead("val",null):k.typeahead("val",b),b}),b.bind("typeahead:selected",function(b,c,d){g(b,c,d),a.$emit("typeahead:selected",c,d)}),b.bind("typeahead:autocompleted",function(b,c,d){g(b,c,d),a.$emit("typeahead:autocompleted",c,d)}),b.bind("typeahead:opened",function(){a.$emit("typeahead:opened")}),b.bind("typeahead:closed",function(){a.$emit("typeahead:closed")}),b.bind("typeahead:asyncrequest",function(){a.$emit("typeahead:asyncrequest")}),b.bind("typeahead:asynccancel",function(){a.$emit("typeahead:asynccancel")}),b.bind("typeahead:asyncreceive",function(){a.$emit("typeahead:asyncreceive")}),b.bind("typeahead:cursorchanged",function(b,c,d){a.$emit("typeahead:cursorchanged",b,c,d)})}}});